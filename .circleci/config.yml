version: 2
jobs:
  build:
    docker:
      - image: circleci/buildpack-deps:16.04
    working_directory: /home/circleci/DEploid
    steps:
      - checkout
      - run: sudo chown -R circleci:circleci *
      - restore_cache:
          key: dEploid-{{ .Branch }}
      - run:
          name: Checkout submodules
          command: |
            git submodule update --init --recursive --remote
      - run:
          name: Install dependencies and set path
          command: |
           sudo apt-get update
           curl -fsSL https://git.io/vHGMF | bash
           sudo apt-get install libcppunit-dev
           sudo apt-get install valgrind
    #- sudo apt-get install zlib1g-dbg
    #- sudo apt-get install python-pip
    #- pip install --user cpp-coveralls
      - run:
           name: Getting ready
           command: |
            ./bootstrap
    ##CIRCLE_NODE_TOTAL=4 circleci-matrix --config /home/circleci/DEploid/.circleci/.circleci-matrix.yml
      - run:
           name: Compile
           command: |
            make
            make check
      - run:
           name: Run tests
           command: |
            ./tests/test_binary.sh
            ./tests/testPOS.sh
            ./tests/test_binaryVcfVsTxt.sh
            ./tests/test-against-previous-version.sh
            ./tests/test_binaryReproducible.sh
        #- valgrind  --leak-check=full -v --show-leak-kinds=all ./unit_tests
    #- coveralls --exclude lib --exclude tests --exclude src/random --exclude src/codeCogs/ --exclude src/export/ --gcov-options '\-lp'
